## Session: 2026-02-23 00:08 - 01:00

### Summary

First CEP session. Completed the entire v0.2.0 Mikado tree: verified bootstrap (cep init assembles CLAUDE.md correctly), wrote all six guidebook chapters plus table of contents, built a bash test harness and 30 functional tests covering all five CLI commands, found and fixed a real bug in `cep upgrade` and `cep diff` (grep exit code not handled under `set -euo pipefail`), and audited the template for stop-too-early, blog, and guidebook instructions — all found adequate, no changes needed.

### Decisions Made

- **Decision:** No template changes, no version bump
  - **Alternatives considered:** Could have added structural guidelines to blog post section or strengthened guidebook maintenance instructions
  - **Why this choice:** Both sections are already comprehensive and actionable. The blog deliberately lacks rigid structure to allow narrative freedom. The guidebook instructions produced a complete 6-chapter book on first use — they work.
  - **Reversibility:** Easy — can add more instructions in any future session

- **Decision:** Test harness uses simple bash functions, not bats or shunit2
  - **Alternatives considered:** bats (Bash Automated Testing System), shunit2
  - **Why this choice:** CEP's "bash-first, no dependencies" principle. The harness is ~150 lines and provides assert_equals, assert_file_exists, assert_file_contains, assert_exit_code, setup/teardown, and a test runner with colored output. That's sufficient for the current test scope.
  - **Reversibility:** Easy — tests are simple functions, migrating to bats would be mechanical

### Mikado Tree Progress

- Active path: goal (all children complete)
- Active node MHC level: 11 (systematic — coordinating the entire v0.2.0 goal)
- [x] Verify cep init assembles CLAUDE.md correctly (MHC 8) — `cep diff` shows zero differences, all placeholders substituted
- [x] Commit bootstrap files (MHC 8) — already committed in `263a5dd`
- [x] overview.md (MHC 10)
- [x] architecture.md (MHC 11)
- [x] cli.md (MHC 10)
- [x] template.md (MHC 10)
- [x] project-anatomy.md (MHC 9)
- [x] vision.md (MHC 10)
- [x] guidebook README.md (MHC 9)
- [x] Write bash test harness (MHC 9)
- [x] Test cep init — 11 tests (MHC 9)
- [x] Test cep upgrade — 6 tests (MHC 9)
- [x] Test cep diff — 5 tests (MHC 9)
- [x] Test cep status and cep list — 8 tests (MHC 9)
- [x] Audit stop-too-early — Rule 4 and shutdown CRITICAL note are adequate (MHC 10)
- [x] Review blog post instructions — comprehensive, no changes needed (MHC 10)
- [x] Review guidebook maintenance instructions — adequate, produced working guidebook (MHC 10)
- [x] Bump VERSION if template changed — no template changes, no bump needed (MHC 8)
- New nodes discovered: none

### TDD Log

**Test harness:** Wrote `tests/test_harness.sh` with assertion functions and runner, then used it immediately in test files.

**Init tests (Red → Green):** Wrote 11 tests. 10 passed immediately (code already existed). One failed: `test_init_injects_local_content` — the test pre-created `.cep/` which triggered the re-init prompt, but didn't pipe `y`. Fixed the test (not the code — the test setup was wrong). All 11 green.

**Upgrade tests (Red → Green):** Wrote 6 tests. 5 passed immediately. One failed: `test_upgrade_reassembles_claude_md` — revealed a real bug in `bin/cep:232`. The pipeline `head | grep | sed` returns exit code 1 when grep finds no match, and `set -euo pipefail` kills the script before the fallback `[[ -z ... ]] && project_name="Unknown"` runs. Fixed by adding `|| true` to the pipeline in both `cmd_upgrade` and `cmd_diff`. All 6 green.

**Diff tests:** 5 tests, all passed.

**Status/list tests:** 8 tests, all passed.

### What I Learned (for Raymond)

**The `set -euo pipefail` + grep + `$()` trap:** This is one of the classic bash gotchas. When you have strict mode enabled (`set -e`) and `pipefail`, a `grep` that finds no matches returns exit code 1, which propagates through the pipeline via `pipefail`, which then triggers `set -e` and kills the script. The pattern `var="$(... | grep ... | ...)"` is especially treacherous because you'd expect `[[ -z "$var" ]]` on the next line to handle the empty case — but the script never reaches that line.

The fix is `|| true` at the end of the pipeline inside the `$()`. This makes the overall command return 0 regardless of grep's exit code. The alternative would be to use `grep ... || :` (which is equivalent but less readable) or to restructure to avoid grep in a pipeline.

This exact bug would survive code review because the fallback assignment *looks* correct — you'd assume the empty string case is handled. Only testing with edge-case input (a CLAUDE.md without the expected header) catches it.

**`local` masks exit codes in bash:** During debugging, I considered whether `local project_name="$(failing_pipeline)"` would trigger `set -e`. It doesn't — `local` always returns 0, masking the pipeline's exit code. The CLI avoids this by separating `local project_name` (declaration) from `project_name="$(pipeline)"` (assignment). The assignment on its own DOES propagate the exit code. This is a known bash footgun and the separated declaration pattern is the standard defense.

### Open Questions

None — all nodes complete, no decisions deferred.

### Possibilities

- **CI integration:** The test suite (`tests/run_all.sh`) could be wired to a GitHub Action. The tests are fast (all 30 run in under 5 seconds) and have no dependencies.
- **`cep test` command:** Add a CLI command that runs the test suite, making `cep test` the single documented way to run tests.
- **Registry cleanup command:** `cep list` shows "gone" for deleted projects, but there's no way to clean them from the registry. A `cep prune` command would remove stale entries.
- **Template linting:** A command that checks the template for broken placeholders, consistent section ordering, and other structural requirements before assembly.
